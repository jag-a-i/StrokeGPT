<!DOCTYPE html>
<html lang="en">
<head>
<<<<<<< HEAD
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StrokeGPT</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
=======
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StrokeGPT</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root {
      --background-primary: #121212;
      --background-secondary: #1E1E1E;
      --background-tertiary: #2C2C2C;
      --text-primary: #EAEAEA;
      --text-secondary: #B3B3B3;
      --accent-primary: #007AFF;
      --accent-hover: #0056b3;
      --user-bubble-bg: #267dff;
      --bot-bubble-bg: #3E4042;
      --border-color: #333333;
      --shadow-color: rgba(0, 0, 0, 0.5);
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --red: var(--danger-color); /* For visualizer */
      --green: var(--success-color); /* For visualizer */
    }
>>>>>>> abb6cafeac2d32c73113cbded5fac77b851835a4

    * {
      box-sizing: border-box;
      scrollbar-width: thin;
      scrollbar-color: var(--background-tertiary) var(--background-primary);
    }
    
    *::-webkit-scrollbar {
      width: 8px;
    }

    *::-webkit-scrollbar-track {
      background: var(--background-primary);
    }

    *::-webkit-scrollbar-thumb {
      background-color: var(--background-tertiary);
      border-radius: 10px;
      border: 2px solid var(--background-primary);
    }

    html, body {
      height: 100%;
    }

<<<<<<< HEAD
        #main-area { flex-grow: 1; display: flex; flex-direction: column; height: 100%; background-color: var(--background); overflow: hidden; }
        
        #sidebar { padding: 20px; background-color: var(--background-darker); overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; gap: 20px; border-left: 1px solid var(--background-lighter); }
       
        #top-bar { padding: 10px 20px; background-color: var(--background); border-bottom: 1px solid var(--background-lighter); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; position: relative; }
        #toggle-sidebar-btn { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); background: var(--background-lighter); border: none; color: var(--foreground); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; transition: transform 0.3s ease-in-out, background-color 0.2s ease; font-size: 1.2em; display: flex; align-items: center; justify-content: center; }
        
        /* Connection status indicators */
        .connection-status-indicators { display: flex; gap: 15px; align-items: center; }
        .connection-status { display: flex; align-items: center; gap: 5px; font-size: 0.9em; }
        .connection-status.connected { color: var(--cyan); }
        .connection-status.disconnected { color: var(--red); }
        .connection-status-icon { width: 8px; height: 8px; border-radius: 50%; }
        .connection-status-icon.connected { background-color: var(--cyan); }
        .connection-status-icon.disconnected { background-color: var(--red); }
        .setup-btn { background: var(--background-lighter); border: none; color: var(--foreground); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; }
        .setup-btn:hover { background: var(--comment); }
        #toggle-sidebar-btn:hover { background-color: var(--comment); }
        body.sidebar-collapsed #toggle-sidebar-btn { transform: translateY(-50%) rotate(180deg); }
=======
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      color: var(--text-primary);
      background: var(--background-primary);
      height: 100%;
      overflow: hidden;
      display: grid;
      grid-template-columns: 1fr 340px;
      transition: grid-template-columns 0.35s ease-in-out;
    }
>>>>>>> abb6cafeac2d32c73113cbded5fac77b851835a4

    body.sidebar-collapsed {
      grid-template-columns: 1fr 0;
    }

    #main-area {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
    }

    #sidebar {
      padding: 20px;
      background: var(--background-secondary);
      height: 100%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 25px;
      border-left: 1px solid var(--border-color);
      transition: all 0.35s ease-in-out;
      overflow-x: hidden;
    }
    
    body.sidebar-collapsed #sidebar {
        padding: 20px 0;
    }

    #top-bar {
      padding: 10px 20px;
      background: var(--background-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      flex-shrink: 0;
      border-bottom: 1px solid var(--border-color);
    }

<<<<<<< HEAD
        .input-text, .select-box, input[type="number"], .radio-group div { padding: 10px; border: 1px solid var(--background-lighter); background-color: var(--background-lighter); color: var(--foreground); border-radius: 8px; font-size: 1em; width: 100%; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .input-text:focus, .select-box:focus, input[type="number"]:focus { outline: none; border-color: var(--purple); box-shadow: 0 0 0 3px rgba(189, 147, 249, 0.3); }
=======
    #toggle-sidebar-btn {
      position: absolute;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      background: var(--background-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease-in-out;
    }
>>>>>>> abb6cafeac2d32c73113cbded5fac77b851835a4

    #toggle-sidebar-btn:hover {
      background: var(--accent-primary);
      color: white;
    }

    body.sidebar-collapsed #toggle-sidebar-btn {
      transform: translateY(-50%) rotate(180deg);
    }

    #top-bar h1 {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 1px;
    }

    #top-bar .top-bar-info {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-right: 50px;
    }

    #mood-display, #edging-timer {
      background: var(--background-tertiary);
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 0.9em;
      font-weight: 500;
      border: 1px solid var(--border-color);
    }

<<<<<<< HEAD
        /* INTEGRATION: Styles for the radio button group */
        .radio-group { margin-bottom: 15px; text-align: left;}
        .radio-group div { margin-bottom: 8px; padding: 12px; cursor: pointer; border-radius: 8px; }
        .radio-group div:hover { background-color: var(--background-lighter); }
        .radio-group input { margin-right: 10px; accent-color: var(--cyan); }

    </style>
=======
    #edging-timer {
      color: var(--warning-color);
      font-weight: 600;
    }

    #chat-view {
      flex: 1;
      min-height: 0;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    #bottom-input-area {
      padding: 20px;
      border-top: 1px solid var(--border-color);
      background: var(--background-primary);
      flex-shrink: 0;
    }

    .chat-message-container {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      max-width: 85%;
    }
    
    .bot-bubble {
        align-self: flex-start;
    }
    
    .user-bubble {
        align-self: flex-end;
    }
    
    .user-bubble .message-content {
        align-items: flex-end;
    }

    .chat-pfp {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      border: 2px solid var(--border-color);
    }

    .message-content {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .message-bubble {
      padding: 12px 18px;
      border-radius: 20px;
      line-height: 1.6;
      word-wrap: break-word;
      font-size: 1rem;
    }

    .bot-bubble .message-bubble {
      background: var(--bot-bubble-bg);
      border-top-left-radius: 5px;
      color: var(--text-primary);
    }

    .user-bubble .message-bubble {
      background: var(--user-bubble-bg);
      color: white;
      border-top-right-radius: 5px;
    }

    .speaker-name {
      font-size: 0.85em;
      color: var(--text-secondary);
      font-weight: 600;
      padding: 0 10px;
    }
    
    .input-text, .select-box, input[type="number"], textarea, .my-button {
      width: 100%;
      padding: 12px 15px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: var(--background-tertiary);
      color: var(--text-primary);
      outline: none;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease-in-out;
    }

    .input-text:focus, .select-box:focus, input[type="number"]:focus, textarea:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
    }

    #message-input-line {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .my-button {
        background-color: var(--accent-primary);
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
    }
    
    .my-button:hover:not(:disabled) {
        background-color: var(--accent-hover);
    }
    
    .my-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    #message-input-line .my-button {
      width: auto;
      flex-shrink: 0;
    }

    #message-input-line .input-text {
      flex-grow: 1;
    }

    .radio-group {
      display: flex;
      justify-content: space-around;
      background: var(--background-tertiary);
      border-radius: 10px;
      padding: 5px;
      border: 1px solid var(--border-color);
    }

    .radio-group input {
      display: none;
    }

    .radio-group label {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease-in-out;
    }

    .radio-group input:checked + label {
      background: var(--accent-primary);
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    #status-text {
      margin-top: 15px;
      font-size: 0.9em;
      text-align: center;
      color: var(--text-secondary);
      min-height: 1.2em;
    }
    
    .setting-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .setting-section h3 {
        margin: 0 0 5px 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
    }

    .timing-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .timing-row label {
      flex-basis: 50px;
      font-size: 0.9em;
      color: var(--text-secondary);
    }
    
    .timing-row input {
        text-align: center;
    }

    .typing-dots span {
      display: inline-block;
      animation: blink 1.4s infinite both;
      font-size: 1.5em;
      line-height: 1;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes blink {
      0% {
        opacity: 0.2;
      }
      20% {
        opacity: 1;
      }
      100% {
        opacity: 0.2;
      }
    }
    
    .sidebar-button.stop { background-color: var(--danger-color); }
    .sidebar-button.stop:hover { background-color: #a72835; }
    .sidebar-button.edging { background-color: var(--warning-color); color: #121212; }
    .sidebar-button.edging:hover { background-color: #dba90e; }
    .sidebar-button.milking { background-color: #9c27b0; }
    .sidebar-button.milking:hover { background-color: #7b1fa2; }
    
    .audio-toggle-line {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
    }

    /* Onboarding Modal Styles */
    #onboarding-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    #onboarding-modal {
        background-color: var(--background-secondary);
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        border: 1px solid var(--border-color);
        box-shadow: 0 10px 30px var(--shadow-color);
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    #onboarding-modal h2 {
        margin: 0 0 5px 0;
        text-align: center;
        color: var(--text-primary);
    }
    
    #onboarding-modal p {
        margin: 0 0 15px 0;
        text-align: center;
        color: var(--text-secondary);
    }

    #onboarding-modal label {
        font-weight: 600;
        margin-bottom: -5px;
        color: var(--text-secondary);
    }
    
    .onboarding-note {
        font-size: 0.8rem;
        color: var(--text-secondary);
        opacity: 0.8;
        margin: -10px 0 0 5px;
    }

    .onboarding-sliders {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-top: 10px;
    }
    
    .slider-group input[type="range"] {
        width: 100%;
    }

  </style>
>>>>>>> abb6cafeac2d32c73113cbded5fac77b851835a4
</head>
<body>
  <div id="main-area">
    <div id="top-bar">
      <h1>StrokeGPT</h1>
      <div class="top-bar-info">
        <div id="mood-display">Mood: Curious 🤔</div>
        <div id="edging-timer" style="display:none;">Edging: 0m 00s</div>
      </div>
      <button id="toggle-sidebar-btn">⟨</button>
    </div>
<<<<<<< HEAD
    <div id="main-area">
        <div id="top-bar">
            <h1>StrokeGPT</h1>
            <div class="top-bar-info">
                <div class="connection-status-indicators">
                    <div id="device-status" class="connection-status">
                        <span class="connection-status-icon disconnected" id="device-status-icon"></span>
                        <span id="device-status-text">Device: Disconnected</span>
                    </div>
                    <div id="ai-status" class="connection-status">
                        <span class="connection-status-icon disconnected" id="ai-status-icon"></span>
                        <span id="ai-status-text">AI: Disconnected</span>
                    </div>
                </div>
                <div id="edging-timer" style="display: none;">00:00</div>
                <div id="mood-display">Mood: ...</div>
            </div>
            <button id="setup-btn" class="setup-btn">Settings</button>
            <button id="toggle-sidebar-btn">&laquo;</button>
        </div>
        <div id="chat-view">
            <div id="chat-messages-container">
                <div id="typing-indicator" class="chat-message-container bot-bubble" style="display: none;">
                    <img class="chat-pfp" id="typing-indicator-pfp" src="/static/default-pfp.png" alt="pfp">
                    <div class="message-content">
                        <p class="speaker-name">BOT</p>
                        <p class="message-bubble typing-dots"><span>.</span><span>.</span><span>.</span></p>
                    </div>
                </div>
            </div>
        </div>
        <div id="bottom-input-area">
            <div id="visualizer-box"><canvas id="rhythm-canvas"></canvas></div>
            <div id="message-input-line">
                <input type="text" id="user-chat-input" class="input-text" placeholder="Type a message or command...">
                <button id="send-chat-btn" class="my-button">Send</button>
            </div>
             <div id="status-text">Status: Checking for saved settings...</div>
=======

    <div id="chat-view">
      <div id="chat-messages-container" style="flex:0 0 auto; display: flex; flex-direction: column; gap: 15px;"></div>
      <div id="typing-indicator" class="chat-message-container bot-bubble" style="display:none;">
        <img id="typing-indicator-pfp" class="chat-pfp" src="/static/default-pfp.png" alt="AI PFP">
        <div class="message-content">
          <div class="speaker-name">BOT</div>
          <div class="message-bubble"><div class="typing-dots"><span>.</span><span>.</span><span>.</span></div></div>
>>>>>>> abb6cafeac2d32c73113cbded5fac77b851835a4
        </div>
      </div>
    </div>
<<<<<<< HEAD
    <div id="sidebar">
        <!-- INTEGRATION: New section for selecting the device interface -->
        <div class="setting-section">
            <h3>Device</h3>
            <div class="radio-group">
                <div><input type="radio" id="if-handy" name="interface" value="handy"><label for="if-handy">The Handy</label></div>
                <div><input type="radio" id="if-buttplug" name="interface" value="buttplug"><label for="if-buttplug">Buttplug.io / Intiface</label></div>
            </div>
        </div>

        <div class="setting-section">
            <h3>Persona</h3>
            <label for="pfp-upload" style="cursor: pointer; display: block; margin-bottom: 15px;">
                <img id="ai-pfp-preview" src="/static/default-pfp.png" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 10px auto; display: block; border: 2px solid var(--comment);">
            </label>
            <input type="file" id="pfp-upload" accept="image/*" style="display: none;">
            <input type="text" id="ai-name-input" class="input-text" placeholder="AI's Name..." style="margin-bottom: 10px;">
            <button id="set-ai-name-btn" class="my-button" style="margin-bottom: 15px;">Set Name</button>
            <input type="text" id="persona-input" class="input-text" placeholder="Describe the AI's persona...">
            <button id="set-persona-btn" class="my-button" style="margin-top: 10px;">Set Persona</button>
        </div>

        <!-- INTEGRATION: This section is now conditional and will be hidden if not using The Handy -->
        <div class="setting-section" id="handy-key-section" style="display: none;">
            <h3>Handy Connection Key</h3>
            <input type="password" id="handy-key-input" class="input-text" placeholder="Handy Key...">
            <button id="set-handy-key-btn" class="my-button" style="margin-top: 10px;">Set Key</button>
        </div>

        <div class="setting-section">
            <h3>Mode Timings (Seconds)</h3>
            <div class="timing-row"><label for="auto-min-time">Auto:</label><input type="number" id="auto-min-time" min="1" max="60" step="1" value="4" title="Minimum Auto Time" placeholder="Min"><span>-</span><input type="number" id="auto-max-time" min="1" max="60" step="1" value="7" title="Maximum Auto Time" placeholder="Max"></div>
            <div class="timing-row"><label for="edging-min-time">Edging:</label><input type="number" id="edging-min-time" min="1" max="60" step="1" value="5" title="Minimum Edging Time" placeholder="Min"><span>-</span><input type="number" id="edging-max-time" min="1" max="60" step="1" value="8" title="Maximum Edging Time" placeholder="Max"></div>
            <div class="timing-row"><label for="milking-min-time">Milking:</label><input type="number" id="milking-min-time" min="1" max="60" step="1" value="2" title="Minimum Milking Time" placeholder="Min"><span>-</span><input type="number" id="milking-max-time" min="1" max="60" step="1" value="5" title="Maximum Milking Time" placeholder="Max"></div>
            <button id="save-timings-btn" class="my-button">Save Timings</button>
        </div>
        <div class="setting-section">
            <h3>Voice Output (ElevenLabs)</h3>
            <input type="password" id="elevenlabs-key-input" class="input-text" placeholder="ElevenLabs API Key">
            <button id="set-elevenlabs-key-button" class="my-button">Set Key</button>
            <select id="elevenlabs-voice-select-box" class="select-box" disabled><option>Set API Key to load voices...</option></select>
            <div class="audio-toggle-line"><input type="checkbox" id="enable-audio-checkbox"><label for="enable-audio-checkbox">Enable Audio</label></div>
        </div>
        <div class="setting-section">
            <h3>Control Actions</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;"><button id="start-auto-btn" class="my-button" style="flex: 1;">Start Auto</button><button id="stop-auto-btn" class="my-button" style="flex: 1;">Stop Auto</button></div>
            <div style="display: flex; gap: 10px;"><button id="like-this-move-btn" class="my-button" style="flex: 1;">👍 Like</button><button id="toggle-memory-btn" class="my-button" style="flex: 1;">Memories: ON</button></div>
            <button id="im-close-btn" class="my-button sidebar-button milking" style="display: none; margin-top: 10px;">I'm Close!</button>
        </div>
        <div class="setting-section" style="margin-top: auto;">
            <h3>DANGER ZONE</h3>
            <button id="edging-mode-btn" class="my-button sidebar-button edging" style="margin-bottom: 10px;">Edge Me</button>
            <button id="milking-mode-btn" class="my-button sidebar-button milking" style="margin-bottom: 10px;">Milk Me</button>
            <button id="emergency-stop-all-btn" class="my-button sidebar-button stop">STOP EVERYTHING</button>
        </div>
    </div>
    <div id="setup-overlay"><div id="setup-box"></div></div>
    <div id="easter-egg-overlay"></div>
    <script>
        const D = document;
        const userChatInput = D.getElementById('user-chat-input');
        const personaInput = D.getElementById('persona-input');
        const setPersonaBtn = D.getElementById('set-persona-btn');
        const aiNameInput = D.getElementById('ai-name-input');
        const setAiNameBtn = D.getElementById('set-ai-name-btn');
        const elevenLabsKeyInput = D.getElementById('elevenlabs-key-input');
        const setElevenLabsKeyButton = D.getElementById('set-elevenlabs-key-button');
        const setupOverlay = D.getElementById('setup-overlay');
        const setupBox = D.getElementById('setup-box');
        const statusText = D.getElementById('status-text');
        const moodDisplay = D.getElementById('mood-display');
        const rhythmCanvas = D.getElementById('rhythm-canvas');
        const typingIndicator = D.getElementById('typing-indicator');
        const chatView = D.getElementById('chat-view');
        const chatMessagesContainer = D.getElementById('chat-messages-container');
        const pfpUploadInput = D.getElementById('pfp-upload');
        const pfpPreview = D.getElementById('ai-pfp-preview');
        const typingIndicatorPfp = D.getElementById('typing-indicator-pfp');
        const toggleSidebarBtn = D.getElementById('toggle-sidebar-btn');
        const imCloseBtn = D.getElementById('im-close-btn');
        const edgingModeBtn = D.getElementById('edging-mode-btn');
        const edgingTimer = D.getElementById('edging-timer');
        const easterEggOverlay = D.getElementById('easter-egg-overlay');
        const ctx = rhythmCanvas.getContext('2d');
        
        // INTEGRATION: Get all new and relevant DOM elements
        const handyKeySection = D.getElementById('handy-key-section');
        const handyKeyInput = D.getElementById('handy-key-input');
        const setHandyKeyBtn = D.getElementById('set-handy-key-btn');
        const handyRadio = D.getElementById('if-handy');
        const buttplugRadio = D.getElementById('if-buttplug');

        // INTEGRATION: Global variable to hold the currently selected interface
        let currentInterface = null;
        let myHandyKey = '', myPersonaDescription = '', aiName = 'BOT', edgingTimerInterval = null;
        
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, options);
                const contentType = response.headers.get("content-type");
                if (!response.ok) { 
                    const errData = await (contentType && contentType.includes("application/json") ? response.json() : { "message": await response.text() });
                    console.error(`HTTP error! status: ${response.status}`, errData);
                    const errorMessage = errData.message || (errData.messages ? errData.messages.join(', ') : 'Unknown server error');
                    addChatMessage('BOT', `SERVER ERROR: ${errorMessage}`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                if (contentType && contentType.includes("audio/mpeg")) { return response.blob(); }
                return response.json();
            } catch (error) {
                console.error(`API call to ${endpoint} failed:`, error);
                statusText.textContent = `Error: Cannot connect to server.`;
                return null; // Return null on failure
            }
        }

        // INTEGRATION: Function to show/hide UI elements based on selected interface
        function updateUIVisibility() {
            if (currentInterface === 'handy') {
                handyKeySection.style.display = 'block';
            } else {
                handyKeySection.style.display = 'none';
            }
        }
=======

    <div id="bottom-input-area">
      <div id="rhythm-visualizer" style="height:80px;background:var(--background-secondary);border:1px solid var(--border-color);border-radius:10px;margin-bottom:15px; overflow: hidden;">
        <canvas id="rhythm-canvas" style="width:100%;height:100%;"></canvas>
      </div>
      <div id="message-input-line">
        <input id="user-chat-input" class="input-text" placeholder="Type here..."/>
        <button id="send-chat-btn" class="my-button">Send</button>
      </div>
      <div id="status-text">Status: Checking for saved settings...</div>
    </div>
  </div>

  <div id="sidebar">
    <div class="setting-section">
      <h3>Persona</h3>
      <label for="pfp-upload" style="cursor:pointer;display:block;margin-bottom:10px;">
        <img id="ai-pfp-preview" src="/static/default-pfp.png" style="width:100px;height:100px;border-radius:50%;object-fit:cover;margin:10px auto;display:block;border:3px solid var(--border-color);" />
      </label>
      <input type="file" id="pfp-upload" accept="image/*" style="display:none"/>
      <input type="text" id="ai-name-input" class="input-text" placeholder="AI's Name..." />
      <button id="set-ai-name-btn" class="my-button">Set Name</button>
      <textarea id="persona-input" class="input-text" placeholder="Describe the AI's persona..." rows="3"></textarea>
      <button id="set-persona-btn" class="my-button">Set Persona</button>
      <div class="setting-subsection" style="margin-top:10px;">
        <label>Reply Length</label>
        <div class="radio-group">
          <input type="radio" id="len-short" name="reply-length" value="short"><label for="len-short">Short</label>
          <input type="radio" id="len-medium" name="reply-length" value="medium" checked><label for="len-medium">Medium</label>
          <input type="radio" id="len-long" name="reply-length" value="long"><label for="len-long">Long</label>
        </div>
      </div>
    </div>

    <div class="setting-section">
      <h3>Mode Timings (Seconds)</h3>
      <div class="timing-row"><label>Auto</label><input type="number" class="input-text" id="auto-min-time" min="0.5" max="60" step="0.5" value="4"><span>-</span><input type="number" class="input-text" id="auto-max-time" min="1" max="60" step="1" value="7"></div>
      <div class="timing-row"><label>Edge</label><input type="number" class="input-text" id="edging-min-time" min="0.5" max="60" step="0.5" value="5"><span>-</span><input type="number" class="input-text" id="edging-max-time" min="1" max="60" step="1" value="8"></div>
      <div class="timing-row"><label>Milk</label><input type="number" class="input-text" id="milking-min-time" min="0.3" max="60" step="0.1" value="2.5"><span>-</span><input type="number" class="input-text" id="milking-max-time" min="0.5" max="60" step="0.5" value="4.5"></div>
    </div>

    <div class="setting-section">
      <h3>Audio</h3>
      <input id="elevenlabs-key-input" class="input-text" placeholder="ElevenLabs API key">
      <button id="set-elevenlabs-key-button" class="my-button">Save API Key</button>
      <select id="elevenlabs-voice-select-box" class="select-box" disabled><option>Set API Key to load voices...</option></select>
      <div class="audio-toggle-line"><input type="checkbox" id="enable-audio-checkbox"><label for="enable-audio-checkbox">Enable Audio</label></div>
    </div>

    <div class="setting-section">
      <h3>Control Actions</h3>
      <div style="display:flex;gap:10px;">
        <button id="start-auto-btn" class="my-button" style="flex:1;">Start Auto</button>
        <button id="stop-auto-btn" class="my-button" style="flex:1;">Stop Auto</button>
      </div>
      <div style="display:flex;gap:10px;">
        <button id="like-this-move-btn" class="my-button" style="flex:1;">Like This Move</button>
        <button id="memories-toggle-btn" class="my-button" style="flex:1;">Memories: ON</button>
      </div>
      <button id="im-close-btn" class="my-button sidebar-button milking" style="display:none;">I'm Close!</button>
    </div>

    <div class="setting-section" style="margin-top:auto;">
      <h3>DANGER ZONE</h3>
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <button id="edging-mode-btn" class="my-button sidebar-button edging">Edge Me</button>
        <button id="milking-mode-btn" class="my-button sidebar-button milking">Milk Me</button>
        <button id="emergency-stop-all-btn" class="my-button sidebar-button stop">STOP EVERYTHING</button>
      </div>
    </div>
  </div>
  
  <div id="onboarding-overlay" style="display: none;">
    <div id="onboarding-modal">
        <h2>Welcome to StrokeGPT</h2>
        <p>Please configure your device and AI persona to get started.</p>
        
        <label for="onboarding-key">Handy Connection Key</label>
        <input type="text" id="onboarding-key" class="input-text" placeholder="Enter your connection key...">
        
        <label for="onboarding-persona">AI Persona</label>
        <textarea id="onboarding-persona" class="input-text" rows="3" placeholder="e.g., a horny catgirl or a sentient but surprisingly spritely block of cheese."></textarea>
        
        <div class="onboarding-sliders">
            <div class="slider-group">
                <label>Speed Range: <span id="onboarding-speed-val">0 - 100</span>%</label>
                <p class="onboarding-note">Note: 15% is often plenty fast enough for a max speed.</p>
                <input type="range" id="onboarding-min-speed" min="0" max="100" value="0">
                <input type="range" id="onboarding-max-speed" min="0" max="100" value="100">
            </div>
            <div class="slider-group">
                <label>Depth Range: <span id="onboarding-depth-val">0 - 100</span>%</label>
                <p class="onboarding-note">The top slider is the base of your dick and the bottom one is your tip. The handy goes from 1 (base) to 100 (tip), so guestimate where your tip is. You can always change it later.</p>
                <input type="range" id="onboarding-min-depth" min="0" max="100" value="0">
                <input type="range" id="onboarding-max-depth" min="0" max="100" value="100">
            </div>
        </div>
        
        <button id="onboarding-save-btn" class="my-button" style="margin-top: 15px;">Save & Start</button>
    </div>
  </div>

  <script>
    const D = document;

    // Elements
    const userChatInput = D.getElementById('user-chat-input');
    const personaInput = D.getElementById('persona-input');
    const aiNameInput = D.getElementById('ai-name-input');
    const elevenLabsKeyInput = D.getElementById('elevenlabs-key-input');
    const setElevenLabsKeyButton = D.getElementById('set-elevenlabs-key-button');
    const statusText = D.getElementById('status-text');
    const moodDisplay = D.getElementById('mood-display');
    const rhythmCanvas = D.getElementById('rhythm-canvas');
    const typingIndicator = D.getElementById('typing-indicator');
    const chatView = D.getElementById('chat-view');
    const chatMessagesContainer = D.getElementById('chat-messages-container');
    const pfpUploadInput = D.getElementById('pfp-upload');
    const pfpPreview = D.getElementById('ai-pfp-preview');
    const typingIndicatorPfp = D.getElementById('typing-indicator-pfp');
    const toggleSidebarBtn = D.getElementById('toggle-sidebar-btn');
    const imCloseBtn = D.getElementById('im-close-btn');
    const onboardingOverlay = D.getElementById('onboarding-overlay');

    let myHandyKey = "";
    let myPersonaDescription = "";
    let replyLength = "medium";
    let ctx = rhythmCanvas.getContext('2d');

    function applySidebarState(){
      const collapsed = localStorage.getItem('sidebar_collapsed') === 'true';
      document.body.classList.toggle('sidebar-collapsed', collapsed);
    }
    toggleSidebarBtn.addEventListener('click', ()=>{
      document.body.classList.toggle('sidebar-collapsed');
      localStorage.setItem('sidebar_collapsed', document.body.classList.contains('sidebar-collapsed'));
    });
    applySidebarState();

    function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function scrollToBottom(){
        setTimeout(() => {
            chatView.scrollTop = chatView.scrollHeight;
        }, 50);
    }
>>>>>>> abb6cafeac2d32c73113cbded5fac77b851835a4

    function updateModeButtons(active){
      const autoBtn = D.getElementById('start-auto-btn');
      const edgeBtn = D.getElementById('edging-mode-btn');
      const milkBtn = D.getElementById('milking-mode-btn');
      const stopAutoBtn = D.getElementById('stop-auto-btn');
      const emergencyBtn = D.getElementById('emergency-stop-all-btn');
      const running = !!active;
      [autoBtn,edgeBtn,milkBtn].forEach(b=>{ if(b) b.disabled = running; });
      if (stopAutoBtn) stopAutoBtn.disabled = !running;
      if (emergencyBtn) emergencyBtn.disabled = false;
      if (imCloseBtn) imCloseBtn.style.display = active === 'edging' ? 'block' : 'none';
    }

    async function apiCall(path, opts={}){
      try{
        const res = await fetch(path, opts);
        if (res.headers.get('content-type')?.includes('audio/')) return await res.arrayBuffer();
        return await res.json();
      }catch(e){
        if (statusText) statusText.textContent = `Error: ${e.message}`;
        return null;
      }
    }

    function addUserMessageToChat(text){
      if (!text) return;
      const div = D.createElement('div');
      div.className = 'chat-message-container user-bubble';
      div.innerHTML = `<div class="message-content"><div class="message-bubble">${escapeHTML(text)}</div></div>`;
      chatMessagesContainer.appendChild(div);
      scrollToBottom();
    }

    async function sendUserMessage(message){
      const text = (message||"").trim();
      
      const currentPersona = personaInput.value.trim();
      if (currentPersona !== myPersonaDescription) {
          myPersonaDescription = currentPersona;
      }

      if (!text && !myPersonaDescription) return;
      
      if (text) {
          addUserMessageToChat(text);
      }
      userChatInput.value = "";
      typingIndicator.style.display = 'flex';
      scrollToBottom();

      const payload = { message: text, key: myHandyKey, persona_desc: myPersonaDescription, reply_length: replyLength };
      await apiCall('/send_message', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    }

    function resizeCanvas(){
      if (!rhythmCanvas.parentElement) return;
      rhythmCanvas.width = rhythmCanvas.parentElement.clientWidth;
      rhythmCanvas.height = rhythmCanvas.parentElement.clientHeight;
    }

    function drawHandyVisualizer(speed, depth){
      const width = rhythmCanvas.width, height = rhythmCanvas.height;
      if (!width || !height) return;
      
      const barHeight = (height/2) - 4;
      const ctx2 = ctx;
      const style = getComputedStyle(document.body);

      ctx2.clearRect(0, 0, width, height);
      
      ctx2.fillStyle = 'rgba(220, 53, 69, 0.2)'; 
      ctx2.fillRect(0, 0, width, barHeight);
      ctx2.fillStyle = style.getPropertyValue('--danger-color').trim();
      ctx2.fillRect(0, 0, (speed/100) * width, barHeight);
      
      ctx2.fillStyle = 'rgba(40, 167, 69, 0.2)';
      ctx2.fillRect(0, barHeight + 8, width, barHeight);
      ctx2.fillStyle = style.getPropertyValue('--success-color').trim();
      ctx2.fillRect(0, barHeight + 8, (100 - depth) / 100 * width, barHeight);
      
      ctx2.fillStyle = 'rgba(255, 255, 255, 0.9)';
      ctx2.font = "600 12px Inter";
      ctx2.textAlign = 'left';
      ctx2.fillText(`Speed: ${speed}%`, 10, barHeight / 2 + 5);
      ctx2.fillText(`Depth: ${depth}%`, 10, barHeight + 8 + (barHeight / 2) + 5);
    }

    async function startupCheck(){
      const data = await apiCall('/check_settings');
      if (data && data.configured){
        onboardingOverlay.style.display = 'none';
        myPersonaDescription = data.persona || "";
        personaInput.value = myPersonaDescription;
        myHandyKey = data.handy_key || "";
        if (data.ai_name) {
          aiNameInput.value = data.ai_name;
          document.querySelectorAll('.speaker-name').forEach(el=>{
            if (el.textContent === 'BOT') el.textContent = data.ai_name;
          });
        }
        if (data.pfp) { pfpPreview.src = data.pfp; typingIndicatorPfp.src = data.pfp; }
        if (data.timings){
          D.getElementById('auto-min-time').value = data.timings.auto_min;
          D.getElementById('auto-max-time').value = data.timings.auto_max;
          D.getElementById('edging-min-time').value = data.timings.edging_min;
          D.getElementById('edging-max-time').value = data.timings.edging_max;
          D.getElementById('milking-min-time').value = data.timings.milking_min;
          D.getElementById('milking-max-time').value = data.timings.milking_max;
        }
        if (data.elevenlabs_key){
          elevenLabsKeyInput.value = data.elevenlabs_key;
          setElevenLabsKeyButton.click();
        }
        if (data.reply_length){
          const r = D.querySelector(`input[name="reply-length"][value="${data.reply_length}"]`);
          if (r) r.checked = true;
          replyLength = data.reply_length;
        }
        statusText.textContent = "Ready.";
      } else {
        onboardingOverlay.style.display = 'flex';
      }
    }

    // --- Onboarding Logic ---
    function setupOnboarding(){
        const minSpeed = D.getElementById('onboarding-min-speed');
        const maxSpeed = D.getElementById('onboarding-max-speed');
        const speedVal = D.getElementById('onboarding-speed-val');
        const minDepth = D.getElementById('onboarding-min-depth');
        const maxDepth = D.getElementById('onboarding-max-depth');
        const depthVal = D.getElementById('onboarding-depth-val');
        const saveBtn = D.getElementById('onboarding-save-btn');

        function updateSliderLabels() {
            if (parseInt(minSpeed.value) > parseInt(maxSpeed.value)) {
                maxSpeed.value = minSpeed.value;
            }
            speedVal.textContent = `${minSpeed.value} - ${maxSpeed.value}`;

<<<<<<< HEAD
        function resizeCanvas() {
            if (!rhythmCanvas.parentElement) return;
            rhythmCanvas.width = rhythmCanvas.parentElement.clientWidth;
            rhythmCanvas.height = rhythmCanvas.parentElement.clientHeight;
        }

        function drawHandyVisualizer(speed, depth) {
            const width = rhythmCanvas.width, height = rhythmCanvas.height;
            if (width === 0 || height === 0) return;
            const barHeight = (height / 2) - 4;
            ctx.clearRect(0, 0, width, height);
            ctx.font = "12px sans-serif";
            ctx.fillStyle = 'rgba(255, 85, 85, 0.3)';
            ctx.fillRect(0, 0, width, barHeight);
            ctx.fillStyle = 'var(--red)';
            ctx.fillRect(0, 0, (speed / 100) * width, barHeight);
            ctx.fillStyle = 'white';
            ctx.fillText(`Speed: ${speed}%`, 5, barHeight / 2 + 5);
            ctx.fillStyle = 'rgba(255, 184, 108, 0.3)';
            ctx.fillRect(0, height / 2 + 4, width, barHeight);
            ctx.fillStyle = '#ffb86c';
            ctx.fillRect(0, height / 2 + 4, (depth / 100) * width, barHeight);
            ctx.fillStyle = 'white';
            ctx.fillText(`Depth: ${depth}%`, 5, height - (barHeight/2) + 5);
        }

        function startEdgingTimer() {
            if (edgingTimerInterval) clearInterval(edgingTimerInterval);
            edgingTimer.style.display = 'block';
            let seconds = 0;
            edgingTimerInterval = setInterval(() => {
                seconds++;
                const min = Math.floor(seconds / 60).toString().padStart(2, '0');
                const sec = (seconds % 60).toString().padStart(2, '0');
                edgingTimer.textContent = `${min}:${sec}`;
            }, 1000);
        }

        function stopEdgingTimer() {
            clearInterval(edgingTimerInterval);
            edgingTimerInterval = null;
            edgingTimer.style.display = 'none';
        }

        // INTEGRATION: Overhauled Setup Wizard
        function renderSetup(isReturningUser = false, data = {}) {
            setupOverlay.style.display = 'flex';
            let step = 1;

            async function handleInterfaceSelection(selectedInterface) {
                currentInterface = selectedInterface;
                statusText.textContent = `Connecting to ${selectedInterface}...`;
                await apiCall('/set_interface', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({interface: currentInterface})});
                (currentInterface === 'handy' ? handyRadio : buttplugRadio).checked = true;
                updateUIVisibility();
            }
            
            function displayStep() {
                if (step === 1) { // Choose Interface
                    setupBox.innerHTML = `<h2>Step 1: Choose Your Device</h2>
                    <div class="radio-group">
                        <div><input type="radio" id="setup-if-handy" name="setup-interface" value="handy"><label for="setup-if-handy">The Handy</label></div>
                        <div><input type="radio" id="setup-if-buttplug" name="setup-interface" value="buttplug"><label for="setup-if-buttplug">Buttplug.io / Intiface Central</label></div>
                    </div>
                    <button id="setup-next" class="my-button">Next</button>`;
                    D.getElementById('setup-next').onclick = async () => {
                        const selected = D.querySelector('input[name="setup-interface"]:checked');
                        if (!selected) return;
                        await handleInterfaceSelection(selected.value);
                        step = currentInterface === 'handy' ? 2 : 3; // Skip key step for buttplug
                        displayStep();
                    };
                } else if (step === 2) { // Handy Key (Handy Only)
                    setupBox.innerHTML = `<h2>Step 2: Handy Key</h2><p>Please enter your connection key from handyfeeling.com</p><input type="password" id="setup-key" class="input-text" placeholder="Handy Key"><br><button id="setup-next" class="my-button">Next</button>`;
                    D.getElementById('setup-next').onclick = async () => {
                        const key = D.getElementById('setup-key').value.trim();
                        if (!key) return;
                        myHandyKey = key;
                        handyKeyInput.value = key;
                        await apiCall('/set_handy_key', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: myHandyKey }) });
                        step = 3; displayStep();
                    };
                } else if (step === 3) { // Persona
                    const stepNum = currentInterface === 'handy' ? 3 : 2;
                    setupBox.innerHTML = `<h2>Step ${stepNum}: Persona</h2><p>Describe your AI partner for this session.</p><input type="text" id="setup-persona" class="input-text" value="${data.persona || 'An energetic and passionate girlfriend'}" placeholder="Describe persona"><br><button id="setup-next" class="my-button">Next</button>`;
                    D.getElementById('setup-next').onclick = () => {
                        personaInput.value = D.getElementById('setup-persona').value.trim();
                        if (isReturningUser || currentInterface === 'buttplug') { // Buttplug setup ends here
                            setupOverlay.style.display = 'none'; 
                            sendUserMessage(''); 
                        } else { // Continue to Handy calibration
                            step = 4; displayStep();
                        }
                    };
                } else if (step === 4 || step === 5) { // Handy Depth Calibration
                    const title = step === 4 ? "Set the Tip" : "Set the Base";
                    const btnText = step === 4 ? "Set Tip" : "Next";
                    const stepNum = step + (currentInterface === 'handy' ? 0 : -1);
                    setupBox.innerHTML = `<h2>Step ${stepNum}: ${title}</h2><p>Move the Handy to the desired position and click '${btnText}'.</p><div><button id="d-down" class="my-button" style="width:auto;">&lt;&lt; Out</button><span id="d-val" style="padding:0 15px;">?</span>%<button id="d-up" class="my-button" style="width:auto;">In &gt;&gt;</button></div><button id="set-pos" class="my-button">${btnText}</button>`;
                    let currentDepth = 50;
                    const updateDepthDisplay = (val) => D.getElementById('d-val').textContent = val;
                    const nudge = async (dir) => { const res = await apiCall('/nudge', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({direction:dir})}); if (res) { currentDepth = res.depth_percent; updateDepthDisplay(currentDepth); } };
                    D.getElementById('d-up').onclick = () => nudge('up');
                    D.getElementById('d-down').onclick = () => nudge('down');
                    D.getElementById('set-pos').onclick = async () => {
                        if (step === 4) { D.minDepth = currentDepth; step = 5; displayStep(); }
                        else { D.maxDepth = currentDepth; await apiCall('/set_depth_limits', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({min_depth:D.minDepth, max_depth:D.maxDepth})}); step = 6; displayStep(); }
                    };
                } else if (step === 6 || step === 7) { // Handy Speed Limits
                    const title = step === 6 ? "Minimum Speed" : "Maximum Speed";
                    const defaultVal = step === 6 ? 10 : 80;
                    const stepNum = step + (currentInterface === 'handy' ? 0 : -1);
                    setupBox.innerHTML = `<h2>Step ${stepNum}: Set ${title}</h2><p>Choose your preferred ${title.toLowerCase()}.</p><div class="slider-container"><input type="range" min="0" max="100" value="${defaultVal}" id="speed-slider"><span id="speed-val">${defaultVal}%</span></div><button id="set-speed" class="my-button">Next</button>`;
                    const slider = D.getElementById('speed-slider');
                    slider.oninput = () => D.getElementById('speed-val').textContent = `${slider.value}%`;
                    D.getElementById('set-speed').onclick = async () => {
                        if (step === 6) { D.minSpeed = slider.value; step = 7; displayStep(); }
                        else { D.maxSpeed = slider.value; await apiCall('/set_speed_limits', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({min_speed:D.minSpeed, max_speed:D.maxSpeed})}); setupOverlay.style.display = 'none'; statusText.textContent = `Setup complete. Ready to chat.`; }
                    };
                }
=======
            if (parseInt(minDepth.value) > parseInt(maxDepth.value)) {
                maxDepth.value = minDepth.value;
>>>>>>> abb6cafeac2d32c73113cbded5fac77b851835a4
            }
            depthVal.textContent = `${minDepth.value} - ${maxDepth.value}`;
        }

<<<<<<< HEAD
        async function startupCheck() {
            const data = await apiCall('/check_settings');
            if (data && data.configured) {
                statusText.textContent = 'Welcome back! Settings loaded.';
                // INTEGRATION: Load saved interface and update UI accordingly
                currentInterface = data.interface;
                (currentInterface === 'handy' ? handyRadio : buttplugRadio).checked = true;
                updateUIVisibility();

                myHandyKey = data.handy_key;
                handyKeyInput.value = myHandyKey;
                personaInput.value = data.persona;
                if(data.ai_name) { aiName = data.ai_name; aiNameInput.value = aiName; D.querySelector('#typing-indicator .speaker-name').textContent = aiName; }
                if (data.pfp) { pfpPreview.src = data.pfp; typingIndicatorPfp.src = data.pfp; }
                if(data.elevenlabs_key) { elevenLabsKeyInput.value = data.elevenlabs_key; setElevenLabsKeyButton.click(); }
                if (localStorage.getItem('sidebar_collapsed') === 'true') { D.body.classList.add('sidebar-collapsed'); }
                
                D.getElementById('splash-screen').style.display = 'none';
                setupOverlay.style.display = 'none'; // Don't show setup if already configured
            } else {
                const startHandler = (e) => { if(e.key === 'Enter'){ D.removeEventListener('keydown', startHandler); D.getElementById('splash-screen').classList.add('hidden'); setTimeout(() => renderSetup(false), 1000); }};
                D.addEventListener('keydown', startHandler);
            }
        }
        
        // --- Event Listeners ---
        D.getElementById('send-chat-btn').addEventListener('click', () => sendUserMessage(userChatInput.value));
        userChatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendUserMessage(userChatInput.value); });
        
        // INTEGRATION: Listen for changes on the interface radio buttons
        async function handleInterfaceChange(event) {
            const selectedInterface = event.target.value;
            if (selectedInterface !== currentInterface) {
                statusText.textContent = `Switching to ${selectedInterface}...`;
                const result = await apiCall('/set_interface', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({interface: selectedInterface}) });
                if (result && result.status === 'success') {
                    currentInterface = selectedInterface;
                    updateUIVisibility();
                    statusText.textContent = `Device interface set to ${selectedInterface}.`;
                } else {
                    statusText.textContent = `Failed to switch to ${selectedInterface}.`;
                    // Revert radio button if failed
                    if(currentInterface) (currentInterface === 'handy' ? handyRadio : buttplugRadio).checked = true;
                }
            }
        }
        handyRadio.addEventListener('change', handleInterfaceChange);
        buttplugRadio.addEventListener('change', handleInterfaceChange);

        setHandyKeyBtn.addEventListener('click', () => {
            const key = handyKeyInput.value.trim();
            if (!key) return;
            myHandyKey = key;
            apiCall('/set_handy_key', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: myHandyKey }) });
            statusText.textContent = 'Handy Key updated!';
        });
        
        setPersonaBtn.addEventListener('click', () => { sendUserMessage(''); statusText.textContent = 'Persona updated!'; });
        
        setAiNameBtn.addEventListener('click', async () => {
            const newName = aiNameInput.value.trim();
            if (!newName) return;
            const data = await apiCall('/set_ai_name', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({name: newName}) });
            if (data && data.status === 'special_persona_activated') {
                easterEggOverlay.innerHTML = `// WARNING: Personality Core Override Detected...<br>// Subject: ${data.persona}<br><br>Good luck.`;
                easterEggOverlay.style.display = 'flex';
                setTimeout(() => { easterEggOverlay.style.opacity = '1'; }, 10);
                setTimeout(() => {
                    easterEggOverlay.style.opacity = '0';
                    setTimeout(() => {
                        easterEggOverlay.style.display = 'none';
                        aiName = data.persona;
                        aiNameInput.value = aiName;
                        D.querySelectorAll('.bot-bubble .speaker-name').forEach(el => el.textContent = aiName);
                        addChatMessage('BOT', data.message);
                    }, 1000);
                }, 3000);
            } else if (data && data.status === 'success') {
                aiName = data.name;
                statusText.textContent = `AI name updated to ${aiName}!`;
                D.querySelectorAll('.bot-bubble .speaker-name').forEach(el => el.textContent = aiName);
            }
        });

        toggleSidebarBtn.addEventListener('click', () => {
            const isCollapsed = D.body.classList.toggle('sidebar-collapsed');
            localStorage.setItem('sidebar_collapsed', isCollapsed);
            setTimeout(resizeCanvas, 350);
        });

        pfpUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64String = reader.result;
                pfpPreview.src = base64String;
                typingIndicatorPfp.src = base64String;
                apiCall('/set_profile_picture', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pfp_b64: base64String }) });
            };
            reader.readAsDataURL(file);
        });
        
        setElevenLabsKeyButton.addEventListener('click', async () => {
            const apiKey = elevenLabsKeyInput.value.trim();
            if(!apiKey) return;
            const data = await apiCall('/setup_elevenlabs', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({api_key:apiKey})});
            if (data && data.status === 'success') {
                const selectBox = D.getElementById('elevenlabs-voice-select-box');
                selectBox.innerHTML = '<option value="">-- Pick a Voice --</option>';
                for (const [name, id] of Object.entries(data.voices)) { selectBox.innerHTML += `<option value="${id}">${name}</option>`; }
                selectBox.disabled = false;
            }
        });

        D.getElementById('like-this-move-btn').addEventListener('click', async () => {
            const data = await apiCall('/like_last_move', { method: 'POST' });
            if (data && data.status === 'boosted') {
                statusText.textContent = `Saved '${data.name}' to my memory!`;
            } else { statusText.textContent = "Status: No active move to like."; }
        });

        const stopButtons = [D.getElementById('stop-auto-btn'), D.getElementById('emergency-stop-all-btn')];
        stopButtons.forEach(btn => btn.addEventListener('click', () => {
            imCloseBtn.style.display = 'none';
            stopEdgingTimer();
            if(btn.id === 'emergency-stop-all-btn') sendUserMessage('stop');
            else apiCall('/stop_auto_mode', {method:'POST'});
        }));

        edgingModeBtn.addEventListener('click', () => {
            apiCall('/start_edging_mode', {method:'POST'});
            imCloseBtn.style.display = 'block';
            startEdgingTimer();
        });

        imCloseBtn.addEventListener('click', () => {
            apiCall('/signal_edge', { method: 'POST' });
            imCloseBtn.style.transform = 'scale(0.95)';
            setTimeout(() => { imCloseBtn.style.transform = ''; }, 100);
        });
        
        D.getElementById('elevenlabs-voice-select-box').addEventListener('change', (e) => apiCall('/set_elevenlabs_voice', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({voice_id: e.target.value, enabled:D.getElementById('enable-audio-checkbox').checked})}));
        D.getElementById('enable-audio-checkbox').addEventListener('change', (e) => apiCall('/set_elevenlabs_voice', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({voice_id: D.getElementById('elevenlabs-voice-select-box').value, enabled: e.target.checked})}));
        D.getElementById('start-auto-btn').addEventListener('click', () => sendUserMessage('take over'));
        D.getElementById('milking-mode-btn').addEventListener('click', () => apiCall('/start_milking_mode', {method:'POST'}));

        // Connection status functions
        function updateConnectionStatus() {
            // This would be called periodically to update connection status
            // For now, we'll implement a basic version
            console.log("Updating connection status...");
        }

        // Setup button handler
        function goToSetup() {
            // Redirect to setup page
            window.location.href = '/setup';
        }

        // Polling for connection status
        setInterval(async () => {
            try {
                const response = await fetch('/setup/status');
                if (response.ok) {
                    const status = await response.json();
                    
                    // Update device status
                    const deviceStatusIcon = document.getElementById('device-status-icon');
                    const deviceStatusText = document.getElementById('device-status-text');
                    if (status.buttplug_connected) {
                        deviceStatusIcon.className = 'connection-status-icon connected';
                        deviceStatusText.textContent = 'Device: Connected';
                    } else {
                        deviceStatusIcon.className = 'connection-status-icon disconnected';
                        deviceStatusText.textContent = 'Device: Disconnected';
                    }
                    
                    // Update AI status
                    const aiStatusIcon = document.getElementById('ai-status-icon');
                    const aiStatusText = document.getElementById('ai-status-text');
                    if (status.llama_connected) {
                        aiStatusIcon.className = 'connection-status-icon connected';
                        aiStatusText.textContent = 'AI: Connected';
                    } else {
                        aiStatusIcon.className = 'connection-status-icon disconnected';
                        aiStatusText.textContent = 'AI: Disconnected';
                    }
                }
            } catch (error) {
                console.error('Error checking connection status:', error);
            }
        }, 2000); // Check every 2 seconds

        setInterval(async () => {
            const data = await apiCall('/get_status');
            if (data) {
                const emoji = {'Curious':'🤔','Teasing':'😉','Playful':'😜','Loving':'❤️','Excited':'✨','Passionate':'🔥','Seductive':'😈','Anticipatory':'👀','Breathless':'🥵','Dominant':'👑','Submissive':'🙇‍♀️','Vulnerable':'😳','Confident':'😏','Intimate':'🥰','Needy':'🥺','Overwhelmed':'🤯','Afterglow':'😌'}[data.mood] || '';
                moodDisplay.textContent = `Mood: ${data.mood} ${emoji}`;
                drawHandyVisualizer(data.speed || 0, data.depth || 0);
            }
        }, 500);

        // Startup
        window.addEventListener('resize', resizeCanvas);
        D.addEventListener('DOMContentLoaded', () => {
            resizeCanvas();
            startupCheck();
            
            // Add event listener for setup button
            const setupBtn = D.getElementById('setup-btn');
            if (setupBtn) {
                setupBtn.addEventListener('click', goToSetup);
            }
        });
        
        // Helper function to add chat messages (for reference, unchanged)
        function addChatMessage(sender, text) {
            const pfpSrc = sender === 'BOT' ? pfpPreview.src : '';
            const pfpHtml = sender === 'BOT' ? `<img class="chat-pfp" src="${pfpSrc}" alt="pfp">` : '';
            const speaker = sender === 'BOT' ? aiName : 'YOU';
            const el = document.createElement('div');
            el.className = `chat-message-container ${sender === 'BOT' ? 'bot-bubble' : 'user-bubble'}`;
            el.innerHTML = `
                ${pfpHtml}
                <div class="message-content">
                    <p class="speaker-name">${speaker}</p>
                    <p class="message-bubble">${text}</p>
                </div>`;
            chatMessagesContainer.insertBefore(el, typingIndicator);
            chatView.scrollTop = chatView.scrollHeight;
        }

    </script>
=======
        [minSpeed, maxSpeed, minDepth, maxDepth].forEach(el => {
            el.addEventListener('input', updateSliderLabels);
        });

        saveBtn.addEventListener('click', async () => {
            const key = D.getElementById('onboarding-key').value.trim();
            const persona = D.getElementById('onboarding-persona').value.trim();
            if (!key) {
                alert('Handy Connection Key is required.');
                return;
            }

            const settings = {
                handy_key: key,
                persona_desc: persona,
                min_speed: minSpeed.value,
                max_speed: maxSpeed.value,
                min_depth: minDepth.value,
                max_depth: maxDepth.value,
            };

            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            const res = await apiCall('/save_onboarding_settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            if (res && res.status === 'ok') {
                location.reload();
            } else {
                alert('Failed to save settings. Please check the server logs.');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save & Start';
            }
        });
    }


    // --- Standard Event Listeners ---
    D.getElementById('edging-mode-btn').addEventListener('click', async ()=>{
      const res = await apiCall('/start_edging_mode', { method:'POST' });
      if (res && res.status === 'error') statusText.textContent = res.message;
    });
    D.getElementById('milking-mode-btn').addEventListener('click', async ()=>{
      const res = await apiCall('/start_milking_mode', { method:'POST' });
      if (res && res.status === 'error') statusText.textContent = res.message;
    });
    D.getElementById('start-auto-btn').addEventListener('click', async ()=>{
      const res = await apiCall('/start_auto_mode', { method:'POST' });
      if (res && res.status === 'error') statusText.textContent = res.message;
    });

    async function emergencyStop(){
      await apiCall('/stop_everything', { method:'POST' });
      if (imCloseBtn) imCloseBtn.style.display = 'none';
      statusText.textContent = 'Stopped.';
    }
    D.getElementById('stop-auto-btn').addEventListener('click', emergencyStop);
    D.getElementById('emergency-stop-all-btn').addEventListener('click', emergencyStop);

    D.getElementById('send-chat-btn').addEventListener('click', ()=> sendUserMessage(userChatInput.value));
    userChatInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendUserMessage(userChatInput.value); });
    D.getElementById('set-persona-btn').addEventListener('click', ()=> {
        myPersonaDescription = personaInput.value.trim();
        statusText.textContent = 'Persona description updated.';
        sendUserMessage('');
    });
    
    D.getElementById('set-ai-name-btn').addEventListener('click', async () => {
        const name = aiNameInput.value.trim();
        if (!name) return;
        await apiCall('/set_ai_name', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
        statusText.textContent = `AI name set to ${name}.`;
    });
    
    D.getElementById('memories-toggle-btn').addEventListener('click', async () => {
        const btn = D.getElementById('memories-toggle-btn');
        const res = await apiCall('/toggle_memory', { method: 'POST' });
        if (res && res.status === 'ok') {
            const state = res.memories_on ? 'ON' : 'OFF';
            btn.textContent = `Memories: ${state}`;
            statusText.textContent = `Long-term memory is now ${state}.`;
        }
    });

    D.querySelectorAll('input[name="reply-length"]').forEach(r=>{
      r.addEventListener('change', async ()=>{
        replyLength = D.querySelector('input[name="reply-length"]:checked').value;
        statusText.textContent = `Reply length set to ${replyLength}.`;
        await fetch('/set_reply_length', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ length: replyLength })});
      });
    });

    pfpUploadInput.addEventListener('change', ()=>{
      const file = pfpUploadInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onloadend = async ()=>{
        const base64 = reader.result;
        pfpPreview.src = base64; typingIndicatorPfp.src = base64;
        const res = await apiCall('/set_profile_picture', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ pfp_b64: base64 })});
        if (res && res.status === 'success' && res.pfp_url){
          pfpPreview.src = res.pfp_url; typingIndicatorPfp.src = res.pfp_url;
        }
      };
      reader.readAsDataURL(file);
    });

    const timingIds = ['auto-min-time','auto-max-time','edging-min-time','edging-max-time','milking-min-time','milking-max-time'];
    function readTimings(){
      const g=id=>parseFloat(D.getElementById(id).value);
      return { auto_min:g('auto-min-time'), auto_max:g('auto-max-time'),
               edging_min:g('edging-min-time'), edging_max:g('edging-max-time'),
               milking_min:g('milking-min-time'), milking_max:g('milking-max-time') };
    }
    timingIds.forEach(id=> D.getElementById(id).addEventListener('change', async ()=>{
      const res = await apiCall('/set_timings', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(readTimings()) });
      if (!res || res.status !== 'ok') statusText.textContent = 'Failed to save timings';
      else statusText.textContent = 'Timings saved.';
    }));

    // Polling
    setInterval(()=>{
      fetch('/get_updates').then(async res=>{
        const ct = res.headers.get('content-type');
        if (ct && ct.includes('audio/')) return;
        return res.json();
      }).then(data=>{
        if (!data) return;
        if (data.messages && data.messages.length){
          typingIndicator.style.display = 'none';
          for (const m of data.messages){
            const div = D.createElement('div');
            div.className = 'chat-message-container bot-bubble';
            div.innerHTML = `<img class="chat-pfp" src="${pfpPreview.src}"><div class="message-content"><div class="speaker-name">${(aiNameInput.value||'BOT')}</div><div class="message-bubble">${m}</div></div>`;
            chatMessagesContainer.appendChild(div);
          }
          scrollToBottom();
        }
      });

      fetch('/get_status').then(res=>res.json()).then(data=>{
        if (!data) return;
        const emoji = {'Curious':'🤔','Teasing':'😉','Playful':'😏','Dominant':'😈','Needy':'🥺','Overwhelmed':'🤯','Afterglow':'😌'}[data.mood] || '';
        moodDisplay.textContent = `Mood: ${data.mood} ${emoji}`;
        drawHandyVisualizer(data.speed || 0, data.depth || 0);
        updateModeButtons(data.active_mode);
      });
    }, 500);

    // Startup
    window.addEventListener('resize', ()=>{ resizeCanvas(); scrollToBottom(); });
    document.addEventListener('DOMContentLoaded', ()=>{ 
        resizeCanvas(); 
        startupCheck(); 
        setupOnboarding();
    });
  </script>
>>>>>>> abb6cafeac2d32c73113cbded5fac77b851835a4
</body>
</html>